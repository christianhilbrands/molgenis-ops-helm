prometheus:
  alertmanager:
    nodeSelector:
      deployPod: "true"
    resources:
      limits:
        cpu: 10m
        memory: 32Mi
      requests:
        cpu: 10m
        memory: 32Mi
  alertmanagerFiles:
    alertmanager.yml:
      global:
        slack_api_url: ''
      receivers:
        - name: default-receiver
          slack_configs:
            - channel: '#alerts'
              send_resolved: true
              text: "{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.message }}\n{{ end }}"
              #text: "<!channel> \n{{ .Annotations.summary }}\n{{ .Annotations.desciption }}"
      route:
        group_wait: 10s
        group_interval: 5m
        receiver: default-receiver
        repeat_interval: 3h

  kubeStateMetrics:
    enabled: false
    nodeSelector:
      deployPod: "false"
    resources:
      limits:
        cpu: 10m
        memory: 64Mi
      requests:
        cpu: 10m
        memory: 64Mi

  nodeExporter:
    enabled: false
    resources:
      limits:
        cpu: 200m
        memory: 50Mi
      requests:
        cpu: 100m
        memory: 30Mi

  pushgateway:
    nodeSelector:
      deployPod: "true"
    resources:
      limits:
        cpu: 10m
        memory: 32Mi
      requests:
        cpu: 10m
        memory: 32Mi

  server:
    nodeSelector:
      deployPod: "true"
    extraSecretMounts:
      - name: scrape-secrets
        secretName: scrape-secrets
        mountPath: /etc/secrets
        readOnly: true
    resources:
      limits:
        cpu: 1
        memory: 6Gi
      requests:
        cpu: 1
        memory: 6Gi
  configmapReload:
    resources:
      limits:
        cpu: 100m
        memory: 64Mi
      requests:
        cpu: 100m
        memory: 64Mi
  serverFiles:
    alerts:
      groups:
        - name: nodes
          rules:
            - alert: "Instance Down"
              expr: up == 0
              annotations:
                severity: "ERROR"
                summary: "Instance Down"
                message: "Instance {{$labels.instance}} is down\nBranch: {{ $labels.branch }}\nProject: {{ $labels.project }}\nDTAP: {{ $labels.dtap }}"
            - alert: OutOfMemory
              expr: node_memory_MemFree / node_memory_MemTotal * 100 < 10
              for: 5m
              annotations:
                severity: warning
                summary: "Out of memory (instance {{ $labels.instance }})"
                message: "Node memory is filling up (< 10% left)\n  VALUE = {{ $value }}\nBranch: {{ $labels.branch }}\nProject: {{ $labels.project }}\nDTAP: {{ $labels.dtap }}"
            - alert: UnusualNetworkThroughputIn
              expr: sum by (instance) (irate(node_network_receive_bytes[2m])) / 1024 / 1024 > 100
              for: 5m
              annotations:
                severity: warning
                summary: "Unusual network throughput in (instance {{ $labels.instance }})"
                message: "Host network interfaces are probably receiving too much data (> 100 MB/s)\n  VALUE = {{ $value }}\nBranch: {{ $labels.branch }}\nProject: {{ $labels.project }}\nDTAP: {{ $labels.dtap }}"
            - alert: UnusualNetworkThroughputOut
              expr: sum by (instance) (irate(node_network_transmit_bytes[2m])) / 1024 / 1024 > 100
              for: 5m
              annotations:
                severity: warning
                summary: "Unusual network throughput out (instance {{ $labels.instance }})"
                message: "Host network interfaces are probably sending too much data (> 100 MB/s)\n  VALUE = {{ $value }}\nBranch: {{ $labels.branch }}\nProject: {{ $labels.project }}\nDTAP: {{ $labels.dtap }}"
            - alert: UnusualDiskReadRate
              expr: sum by (instance) (irate(node_disk_read_bytes[2m])) / 1024 / 1024 > 50
              for: 5m
              annotations:
                severity: warning
                summary: "Unusual disk read rate (instance {{ $labels.instance }})"
                message: "Disk is probably reading too much data (> 50 MB/s)\n  VALUE = {{ $value }}\nBranch: {{ $labels.branch }}\nProject: {{ $labels.project }}\nDTAP: {{ $labels.dtap }}"
            - alert: UnusualDiskWriteRate
              expr: sum by (instance) (irate(node_disk_written_bytes[2m])) / 1024 / 1024 > 50
              for: 5m
              annotations:
                severity: warning
                summary: "Unusual disk write rate (instance {{ $labels.instance }})"
                message: "Disk is probably writing too much data (> 50 MB/s)\n  VALUE = {{ $value }}\nBranch: {{ $labels.branch }}\nProject: {{ $labels.project }}\nDTAP: {{ $labels.dtap }}"
            - alert: OutOfDiskSpace
              expr: node_filesystem_free_bytes{mountpoint ="/rootfs"} / node_filesystem_size_bytes{mountpoint ="/rootfs"} * 100 < 10
              for: 5m
              annotations:
                severity: warning
                summary: "Out of disk space (instance {{ $labels.instance }})"
                message: "Disk is almost full (< 10% left)\n  VALUE = {{ $value }}\nBranch: {{ $labels.branch }}\nProject: {{ $labels.project }}\nDTAP: {{ $labels.dtap }}"
            - alert: OutOfInodes
              expr: node_filesystem_files_free{mountpoint ="/rootfs"} / node_filesystem_files{mountpoint ="/rootfs"} * 100 < 10
              for: 5m
              annotations:
                severity: warning
                summary: "Out of inodes (instance {{ $labels.instance }})"
                message: "Disk is almost running out of available inodes (< 10% left)\n  VALUE = {{ $value }}\nBranch: {{ $labels.branch }}\nProject: {{ $labels.project }}\nDTAP: {{ $labels.dtap }}"
            - alert: UnusualDiskReadLatency
              expr: rate(node_disk_read_time_ms[1m]) / rate(node_disk_reads_completed[1m]) > 100
              for: 5m
              annotations:
                severity: warning
                summary: "Unusual disk read latency (instance {{ $labels.instance }})"
                message: "Disk latency is growing (read operations > 100ms)\n  VALUE = {{ $value }}\nBranch: {{ $labels.branch }}\nProject: {{ $labels.project }}\nDTAP: {{ $labels.dtap }}"
            - alert: UnusualDiskWriteLatency
              expr: rate(node_disk_write_time_ms[1m]) / rate(node_disk_writes_completed[1m]) > 100
              for: 5m
              annotations:
                severity: warning
                summary: "Unusual disk write latency (instance {{ $labels.instance }})"
                message: "Disk latency is growing (write operations > 100ms)\n  VALUE = {{ $value }}\nBranch: {{ $labels.branch }}\nProject: {{ $labels.project }}\nDTAP: {{ $labels.dtap }}"
            - alert: HighCpuLoad
              expr: 100 - (avg by(instance) (irate(node_cpu{mode="idle"}[5m])) * 100) > 80
              for: 5m
              annotations:
                severity: warning
                summary: "High CPU load (instance {{ $labels.instance }})"
                message: "CPU load is > 80%\n  VALUE = {{ $value }}\nBranch: {{ $labels.branch }}\nProject: {{ $labels.project }}\nDTAP: {{ $labels.dtap }}"
            - alert: ContextSwitching
              expr: rate(node_context_switches[5m]) > 1000
              for: 5m
              annotations:
                severity: warning
                summary: "Context switching (instance {{ $labels.instance }})"
                message: "Context switching is growing on node (> 1000 / s)\n  VALUE = {{ $value }}\nBranch: {{ $labels.branch }}\nProject: {{ $labels.project }}\nDTAP: {{ $labels.dtap }}"
            - alert: SwapIsFillingUp
              expr: (1 - (node_memory_SwapFree / node_memory_SwapTotal)) * 100 > 80
              for: 5m
              annotations:
                severity: warning
                summary: "Swap is filling up (instance {{ $labels.instance }})"
                message: "Swap is filling up (>80%)\n  VALUE = {{ $value }}\nBranch: {{ $labels.branch }}\nProject: {{ $labels.project }}\nDTAP: {{ $labels.dtap }}"
      #  - name: pods
      #    rules:
      #      - alert: "Pod OOMKilled"
      #        expr: kube_pod_container_status_terminated_reason{reason='OOMKilled'} == 1
      #        annotations:
      #          severity: "WARN"
      #          message: "Pod {{$labels.container}} in namespace {{$labels.namespace}} got OOMKilled."
      #  - name: services
      #    rules:
      #      - alert: "Many Previews Up"
      #        expr: sum(kube_service_info{namespace=~"preview.*", service=~".*molgenis"}) > 5
      #        annotations:
      #          severity: "DEBUG"
      #          message: "{{$value}} PR previews are currently deployed"
      #  - name: molgenis
      #    rules:
      #      - alert: "Molgenis Down"
      #        expr: up{job="node_exporter_nodes"} == 0
      #        annotations:
      #          severity: "ERROR"
      #          message: "{{$labels.instance}} is down"
    rules: {}
    prometheus.yml: 
      rule_files:
        - /etc/config/rules
        - /etc/config/alerts
extraScrapeConfigs: |
  - job_name: 'masterBranchNodes'
    static_configs:
    - targets: ['molgenis117.gcc.rug.nl:9100'] 
      labels: 
        project: "GCC test server" 
        branch: "master" 
        dtap: "test"
  - job_name: '10BranchNodes'
    static_configs:
    - targets: ['molgenis119.gcc.rug.nl:9100']
      labels: 
        project: "GCC test server" 
        branch: "7.x"
        dtap: "test" 
    - targets: ['molgenis07.gcc.rug.nl:9100']
      labels: 
        project: "Central biobank" 
        branch: "7.x"
        dtap: "acceptance"
    - targets: ['molgenis24.gcc.rug.nl:9100']
      labels: 
        project: "Chromosome6 acceptance server" 
        branch: "7.x"
        dtap: "acceptance"
    - targets: ['molgenis30.gcc.rug.nl:9100']
      labels: 
        project: "UGLI Sample Tracking" 
        branch: "7.x"
        dtap: "acceptance"
    - targets: ['molgenis32.gcc.rug.nl:9100']
      labels: 
        project: "Lung and eQTL pathology UMCG (new)" 
        branch: "7.x"
        dtap: "acceptance"
    - targets: ['molgenis36.gcc.rug.nl:9100']
      labels: 
        project: "Lifecycle acceptance" 
        branch: "7.x"
        dtap: "acceptance"
    - targets: ['molgenis39.gcc.rug.nl:9100']
      labels: 
        project: "BBMRI-DE acceptance German Biobank Directory" 
        branch: "7.x"
        dtap: "acceptance"
    - targets: ['molgenis96.gcc.rug.nl:9100']
      labels: 
        project: "Samplesheets NGS_DNA/RNA" 
        branch: "7.x"
        dtap: "acceptance"
    - targets: ['molgenis101.gcc.rug.nl:9100']
      labels: 
        project: "BBMRI-ERIC" 
        branch: "7.x"
        dtap: "acceptance"
    - targets: ['molgenis112.gcc.rug.nl:9100']
      labels: 
        project: "Prenetal WES Acceptance v7.4.8" 
        branch: "7.x"
        dtap: "acceptance"
    - targets: ['molgenis125.gcc.rug.nl:9100']
      labels: 
        project: "Pointing" 
        branch: "7.x"
        dtap: "acceptance"
    - targets: ['molgenis127.gcc.rug.nl:9100']
      labels: 
        project: "RD-Connect acceptance" 
        branch: "7.x"
        dtap: "acceptance"
    - targets: ['molgenis132.gcc.rug.nl:9100']
      labels: 
        project: "The Dutch Microbiome Project" 
        branch: "7.x"
        dtap: "acceptance"
    - targets: ['molgenis133.gcc.rug.nl:9100']
      labels: 
        project: "CHD7" 
        branch: "7.x"
        dtap: "acceptance"
    - targets: ['molgenis137.gcc.rug.nl:9100']
      labels: 
        project: "COL7A1" 
        branch: "7.x"
        dtap: "acceptance"
  - job_name: '20BranchNodes'
    static_configs:
    - targets: ['molgenis121.gcc.rug.nl:9100']
      labels: 
        project: "GCC test server" 
        branch: "8.x"
        dtap: "test" 
#  volumeMounts:
#    - name: config-prometheus
#      mountPath: /etc/config/prometheus.yml
#volumes:
#  - name: config-prometheus
#    configMap:
#      name: prometheus-yaml-config
secret:
  molgenisMetrics: "xxxx"
